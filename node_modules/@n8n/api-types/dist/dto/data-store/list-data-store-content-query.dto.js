"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ListDataStoreContentQueryDto = void 0;
const n8n_workflow_1 = require("n8n-workflow");
const zod_1 = require("zod");
const zod_class_1 = require("zod-class");
const data_store_schema_1 = require("../../schemas/data-store.schema");
const pagination_dto_1 = require("../pagination/pagination.dto");
const FilterConditionSchema = zod_1.z.union([zod_1.z.literal('eq'), zod_1.z.literal('neq')]);
const filterRecord = zod_1.z.object({
    columnName: data_store_schema_1.dataStoreColumnNameSchema,
    condition: FilterConditionSchema.default('eq'),
    value: zod_1.z.union([zod_1.z.string(), zod_1.z.number(), zod_1.z.boolean(), zod_1.z.date()]),
});
const chainedFilterSchema = zod_1.z.union([zod_1.z.literal('and'), zod_1.z.literal('or')]);
const filterSchema = zod_1.z.object({
    type: chainedFilterSchema.default('and'),
    filters: zod_1.z.array(filterRecord).default([]),
});
const filterValidator = zod_1.z
    .string()
    .optional()
    .transform((val, ctx) => {
    if (!val)
        return undefined;
    try {
        const parsed = (0, n8n_workflow_1.jsonParse)(val);
        try {
            return filterSchema.parse(parsed);
        }
        catch (e) {
            ctx.addIssue({
                code: zod_1.z.ZodIssueCode.custom,
                message: 'Invalid filter fields',
                path: ['filter'],
            });
            return zod_1.z.NEVER;
        }
    }
    catch (e) {
        ctx.addIssue({
            code: zod_1.z.ZodIssueCode.custom,
            message: 'Invalid filter format',
            path: ['filter'],
        });
        return zod_1.z.NEVER;
    }
});
const sortByValidator = zod_1.z
    .string()
    .optional()
    .transform((val, ctx) => {
    if (val === undefined)
        return val;
    if (!val.includes(':')) {
        ctx.addIssue({
            code: zod_1.z.ZodIssueCode.custom,
            message: 'Invalid sort format, expected <columnName>:<asc/desc>',
            path: ['sort'],
        });
        return zod_1.z.NEVER;
    }
    let [column, direction] = val.split(':');
    try {
        column = data_store_schema_1.dataStoreColumnNameSchema.parse(column);
    }
    catch {
        ctx.addIssue({
            code: zod_1.z.ZodIssueCode.custom,
            message: 'Invalid sort columnName',
            path: ['sort'],
        });
        return zod_1.z.NEVER;
    }
    direction = direction?.toUpperCase();
    if (direction !== 'ASC' && direction !== 'DESC') {
        ctx.addIssue({
            code: zod_1.z.ZodIssueCode.custom,
            message: 'Invalid sort direction',
            path: ['sort'],
        });
        return zod_1.z.NEVER;
    }
    return [column, direction];
});
class ListDataStoreContentQueryDto extends zod_class_1.Z.class({
    take: pagination_dto_1.paginationSchema.take.optional(),
    skip: pagination_dto_1.paginationSchema.skip.optional(),
    filter: filterValidator.optional(),
    sortBy: sortByValidator.optional(),
}) {
}
exports.ListDataStoreContentQueryDto = ListDataStoreContentQueryDto;
//# sourceMappingURL=list-data-store-content-query.dto.js.map